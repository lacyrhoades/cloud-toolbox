#!/usr/bin/env node

require('dotenv').config()
var cloudinary = require('cloudinary')
var moment = require('moment')

var verbose = false

var config = {
  'cloud_name': process.env.CLOUDINARY_CLOUD_NAME,
  'api_key': process.env.CLOUDINARY_API_KEY,
  'api_secret': process.env.CLOUDINARY_API_SECRET,
}

cloudinary.config(config)

var params = {
  'max_results': 100
}

var cutoffDate = moment().subtract(1, 'week')
var successCount = 0

console.log(`Searching for resources before: ${cutoffDate.format()} ...`)
doBatch()

function doBatch(nextCursor = null) {
  if (nextCursor) {
    params['next_cursor'] = nextCursor
  }

  var deletable = []

  cloudinary.v2.api.resources(params,
    function(error, result){
      if (error) {
        console.error(error)
      }
      
      if (verbose) {
        console.log("Found resources: " + result.resources.length)
      }

      result.resources.forEach(function (eachResource) {
        var created_at = eachResource.created_at
        var date = moment(created_at)
      
        if (date.isBefore(cutoffDate)) {
          deletable.push(eachResource.public_id)
        }
      })

      var nextBatch = function() {
        if (result.next_cursor != null && result.next_cursor.length) {
          doBatch(result.next_cursor)
        } else {
          console.log("Deleted old resources: " + successCount)
        }
      }

      if (deletable.length < 1) {
        if (verbose) {
          console.log("Batch resources newer than date " + cutoffDate.format())
        }
        nextBatch()
      } else {
        doDelete(deletable).then(function (deleted) {
          successCount += deleted.length
          nextBatch()
        }).catch(function(error) {
          console.error(error)
        })
      }
    }
  )
}

function doDelete(resourceIDs) {
  if (verbose) {
    console.log("Deleting resources: " + resourceIDs.length)
  }

  return new Promise( function (next, reject) {
    cloudinary.v2.api.delete_resources(
      resourceIDs,
      function(error, result) {
        if (error) {
          reject(error)
        } else {
          next(resourceIDs)
        }
      }
    );
  })
}
