#!/usr/bin/env node

require('dotenv').config()
var slack = require('slack')
var moment = require('moment')

var verbose = false

var cutoffDate = moment().subtract(30, 'day')

let apiToken = process.env.SLACK_API_TOKEN

var params = {
  token: apiToken,
  ts_to: cutoffDate.unix(),
  count: 1000 
}

slack.files.list(params, function (err, res) {
  let files = res['files']
  console.log(`Found ${files.length} files ...`)
  deleteFiles(files)
})

function deleteFiles(files) {
  files.filter(function (eachFile) {
    if (eachFile['mode'] == 'hosted') {
      return true
    } else {
      console.log("Filtering non-hosted file ...")
      return false
    }
  }).forEach(deleteFile)
}

function deleteFile(file) {
  let id = file['id']
  let name = file['name']
  
  console.log(`Deleting file: ${name}`)
  
  let params = {
    token: apiToken,
    file: id
  }
  
  slack.files.delete(params, function (err, res) {
    console.log(res)
  })
}
